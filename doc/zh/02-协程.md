[上一节](./01-简介.md)

# 02-协程

## 什么是协程

协程是可以**暂停**和**恢复**的函数。在网络和硬盘 IO 中，延迟通常较高，等待 IO 的完成是十分浪费 CPU 时间的。有两种办法可以避免 CPU 时间的浪费：多线程和 IO 多路复用。在 IO 多路复用中，用户向 OS 提交一个 IO 请求后，通常会**暂停**当前的任务，转而处理另一个任务，从而充分地利用等待 IO 的空档期。一段时间后，用户向 OS 询问「有哪些已完成的 IO」，进而逐个**恢复**对应的任务。这里的「任务」有明显的暂停和恢复特征，故非常适合用「协程」来描述他们。

## 如果不使用协程？

在 IO 多路复用中，如果不使用协程，则用户必须使用「函数回调」来描述程序流程。函数回调至少有如下缺点：

- 难以编写：作者很难将程序流程翻译为代码
- 难以阅读：读者很难从代码读懂作者的逻辑
- 难以维护：当程序流程需要修改时，大量的函数回调需要重新梳理和审查

总而言之，大量使用函数回调，会使工程成本急剧上升，容易走向不可维护。

## 如果不使用 IO 多路复用？

如果仅使用多线程而不使用 IO 多路复用，那么代码的可读性会显著提高，避开了上述缺点。但是，当系统并发量增高时，线程数量将线性增长。OS 将忙于在众多线程之间调度和切换，导致有效的 CPU 利用率降低。另一方面，开辟线程需要消耗大量的内存资源，纯多线程能应对的并发压力几乎是触手可及的。

## 如果限制线程数量？

如果仅使用多线程而不使用 IO 多路复用，同时限制线程的数量，则当一定数量的线程陷入阻塞时，无法充分地利用 CPU 资源，并发容量将显著降低。

## 为什么要使用协程？

使用协程，可以避开上述所有缺点，而不引入新的缺陷，集易用性、可读性、性能于一身。

[下一节](./03-你好，协程.md)将使用 co_context 写一个简单的异步程序。
